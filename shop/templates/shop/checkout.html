{% extends "shop/base.html" %}
{% load static %}
    {% block page_title %}
        {{product.p_name}}
    {% endblock page_title %}
    {% block content %}
    <!-- jQuery 로드 -->
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <script>
        // jQuery를 소문자 'jquery'로 바인딩
        window.jquery = window.jQuery;
    </script>

    <!-- iamport 라이브러리 로드 -->
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <div>

        <!-- 회원 주문정보 표시 -->
        {% block mypage_content %}
        
    
        <div>
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>배송 정보 수정</title>
                <link rel="stylesheet" href="{% static 'css/update.css' %}">
                <script src="{% static 'js/jquery-1.11.3.min.js' %}"></script>
                <script src="users/javascript/popup.js"></script>
                <script src="http://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
                <script type="application/json" id="selected-items-data">
                    {{ selected_items_json|escape }}
                </script>
                
            </head>
                <h1>배송 정보</h1>
                <div>
                    <form action="{% url 'users:update' %}" method="POST">
                        {% csrf_token %}
            
                        <div class="form-group">
                            <label for="id_name">이름</label>
                            {{ form.name }}
                        </div>
                        <div class="form-group">
                            <label for="id_tel">전화번호</label>
                            {{ form.tel }}
                        </div>
                        <div class="form-group">
                            <label for="id_postcode">우편번호 <input type="button" onclick="sample6_execDaumPostcode()" value="우편번호 찾기" class="btn-postcode"></label>
                            {{ form.postcode }}
                        </div>
                        <div class="form-group">
                            <label for="id_address">주소</label>
                            {{ form.address }}
                        </div>
                        <div class="form-group">
                            <label for="id_detail_address">상세주소</label>
                            {{ form.detail_address }}
                        </div>
                        <div class="form-group">
                            <label for="id_extra_address">참고항목</label>
                            {{ form.extra_address }}
                        </div>
            
                        <input type="submit" value="수정">
                    </form>
                </div>
            
                <script>
                    function sample6_execDaumPostcode() {
                        new daum.Postcode({
                            oncomplete: function(data) {
                                var addr = ''; // 주소 변수
                                var extraAddr = ''; // 참고항목 변수
            
                                if (data.userSelectedType === 'R') {
                                    addr = data.roadAddress; // 도로명 주소
                                } else {
                                    addr = data.jibunAddress; // 지번 주소
                                }
            
                                if (data.userSelectedType === 'R') {
                                    if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                                        extraAddr += data.bname;
                                    }
                                    if (data.buildingName !== '' && data.apartment === 'Y') {
                                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                                    }
                                    if (extraAddr !== '') {
                                        extraAddr = ' (' + extraAddr + ')';
                                    }
                                }
            
                                document.getElementById("id_postcode").value = data.zonecode;
                                document.getElementById("id_address").value = addr;
                                document.getElementById("id_extra_address").value = extraAddr;
            
                                document.getElementById("id_detail_address").focus();
                            }
                        }).open();
                    }
                </script>
            </body>
            {% endblock mypage_content %}
        </div>

                


        <table>
            <thead>
                <tr>
                    <th>상품명</th>
                    <th>사이즈</th>
                    <th>색상</th>
                    <th>수량</th>
                    <th>가격</th>
                </tr>
            </thead>
            <tbody>
                {% if direct_items %}
                <!-- Direct Purchase Item -->
                    <tr>
                        <td>{{ direct_items.product_name }}</td>
                        <td>{{ direct_items.size_name }}</td>
                        <td>{{ direct_items.color_name }}</td>
                        <td>{{ direct_items.quantity }}</td>
                        <td>{{ direct_items.price|floatformat:2 }}</td>
                    </tr>
            </tbody>
                {% elif selected_items %}
                    {% for item in selected_items %}
                    <tr>
                        <td>{{ item.product }}</td>
                        <td>{{ item.size_name }}</td>
                        <td>{{ item.color_name }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.price|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                        <tr>
                            <td colspan="5">No items to display.</td>
                        </tr>
                {% endif %}    
            </tbody>
        </table>
        <p>총 금액: {{ total|floatformat:2 }} 원</p>

        <div>
            <head>

                <meta charset="UTF-8" />
                <meta http-equiv="X-UA-Compatible" content="IE=edge" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <title>결제페이지</title>
                <!-- jQuery -->
                <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
                <script>
                  type="text/javascript"
                  src="https://code.jquery.com/jquery-1.12.4.min.js"
                </script>
                <!-- iamport.payment.js -->
                <script>
                  type="text/javascript"
                  src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"
                </script>
                <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
                <script>
                    const directItems = {{ direct_item_json|default:"null"|safe }};
                    console.log("Direct Items:", directItems);
                </script>
                
                <script>
                    const selectedItems = {{ selected_items_json|default:"[]"|safe }};
                    console.log("Selected Items:", selectedItems);
                </script>
                <script>
                    const csrfToken = "{{ csrf_token }}";
                </script>
                
                <script>
                function generateMerchantUid() {
                        return 'merchant_' + new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                </script>
                <script>
                    function requestPay() {
                      const merchant_uid = generateMerchantUid();
                      const IMP = window.IMP;  // direct_item_json을 직접 삽입
                      let name = ""; // 상품명 초기화
                  
                      if (directItems) {
                          name = directItems.product_name; // direct_items의 상품명 사용
                      } else if (selectedItems && selectedItems.length > 0) {
                          name = selectedItems.map(item => item.product_name).join(", ");
                      // 데이터가 없을 경우
                      } else {
                          name = "상품명 없음"; // 기본값 설정
                      }
                  
                      console.log("결제 상품명:", name);
  
                      const amount = "{{ total }}";
                      IMP.init("imp71874747"); // 예: imp00000000a
                      IMP.request_pay(
                        {
                          pg: "html5_inicis", //PG사
                          pay_method: "card", //결제방식
                          //merchant_uid: "ORD20180131-0000011", // 주문번호, 상품ID, 생략시 자동생성
                          name: name,
                          amount: amount, // 결제금액
                          merchant_uid: merchant_uid,
                          buyer_email: "{{ user.email }}",	//구매자 이메일
                          buyer_name: "{{ user.name }}",	//구매자 이름
                          buyer_tel: "{{ user.tel }}",	//구매자 전화번호
                          buyer_addr: "{{ user.address }}",	//구매자 주소
                          buyer_postcode: "{{ user.postcode }}",	//구매자 번호
                        },
                        function (rsp) {
                          if (rsp.success) {
                              fetch("{% url 'shop:order_new' %}", {
                                  method: "POST",
                                  headers: {
                                      "Content-Type": "application/json",
                                      "X-CSRFToken": "{{ csrf_token }}",
                                  },
                                  body: JSON.stringify({
                                      imp_uid: rsp.imp_uid,
                                      merchant_uid: rsp.merchant_uid,
                                      paid_amount: rsp.paid_amount,
                                      status: rsp.status,
                                  }),
                              })
                              .then((response) => {
                                  console.log("Response status:", response.status);
                                  console.log("Response headers:", response.headers);
                                  if (!response.ok) {
                                      throw new Error(`HTTP error! status: ${response.status}`);
                                  }
                                  return response.json();
                              })
                              .then((data) => {
                                  console.log("Response data:", data);
                                  if (data.status === "success") {
                                      alert("결제가 완료되었습니다!");
                                      window.location.href = "/shopping_info/"; // 결제 내역 페이지로 이동
                                  } else {
                                      alert("결제 처리 중 오류가 발생했습니다: " + data.message);
                                  }
                              })
                              .catch((error) => {
                                  console.error("결제 데이터 전송 실패:", error);
                                  alert("결제 데이터 전송 실패. 다시 시도해주세요.");
                              });
                      } else {
                          // 결제 실패 처리
                          console.error("결제 완료");
                          alert("결제에 실패하였습니다. 에러 메시지: " + rsp.error_msg);
                      }
                      }
                  );
              }
              </script>
            </head>
            <body>
            <button onclick="requestPay()">결제하기</button>
            </body>
        </div>

        <div class="text-end">
        <a href="{% url 'shop:order_new' %}" class="btn btn-primary">주문하기</a>
        </div>
       
    {% endblock content %}
</div>
<!-- HTML 문서의 맨 아래 -->
<script>
    const directItemsScript = document.getElementById("direct-items-data");
    if (directItemsScript) {
        const directItems = JSON.parse(directItemsScript.textContent);
        console.log("Direct Items:", directItems);
    } else {
        console.error("Direct Items data not found!");
    }
</script>
