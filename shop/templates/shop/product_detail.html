{% extends "shop/base.html" %}
{% load static %}
{% block page_title %}
    {{product.p_name}}
{% endblock page_title %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/product_detail.css' %}">
<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<h2>

    <a href="{% url 'users:user_profile' product.host.username %}">{{ product.host.username }}</a>
    {% if product.host.superhost %}
        (superhost)
    {% endif %}
</h2>
<div class="product-detail-container">
    <!-- ì™¼ìª½: ë©”ì¸ ì´ë¯¸ì§€ (Swiperë¡œ ë³€ê²½) -->
    <div class="product-image">
        <div class="swiper product-image-swiper">
            <div class="swiper-wrapper">
                <div class="swiper-slide">
                    <img src="{{ product.head_image.url }}" alt="{{ product.name }}" class="product-head-image">
                </div>
                {% for detail_image in product.detail_images.all %}
                <div class="swiper-slide">
                    <img src="{{ detail_image.image.url }}" alt="{{ product.name }} - ìƒì„¸ ì´ë¯¸ì§€ {{ forloop.counter }}" class="detail-image">
                </div>
                {% endfor %}
            </div>
            <!-- ë„¤ë¹„ê²Œì´ì…˜ í™”ì‚´í‘œ -->
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div class="swiper-pagination"></div>
        </div>
    </div>
    
    <!-- ì˜¤ë¥¸ìª½: ìƒí’ˆ ì •ë³´ -->
    <div class="product-info">
        <h1>{{ product.name }}</h1>
        <p class="price">{{ product.price }}ì›</p>
        
        <!-- ì¢‹ì•„ìš” ë²„íŠ¼ê³¼ ìˆ˜ í‘œì‹œ -->
        <div class="like-section">
            <button id="like-btn" onclick="toggleLike({{ product.id }})" class="like-button">
                {% if user_has_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}
            </button>
            <span id="like-count">{{ like_count }}</span>ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤
        </div>
        
        <form method="post" action="{% url 'cart:add_cart' product.id %}">
                {% csrf_token %}
        
                <!-- ì‚¬ì´ì¦ˆ ì„ íƒ -->
                <label for="sizecategory">ì‚¬ì´ì¦ˆ:</label>
                <select name="sizecategory" id="sizecategory" required>
                    {% for size in sizes %}
                        <option value="{{ size.id }}">{{ size.name }}</option>
                    {% endfor %}
                </select>
        
                <!-- ìƒ‰ìƒ ì„ íƒ -->
                <label for="colorcategory">ìƒ‰ìƒ:</label>
                <select name="colorcategory" id="colorcategory" required>
                    {% for color in colors %}
                        <option value="{{ color.id }}">{{ color.name }}</option>
                    {% endfor %}
                </select>
        
                <!-- ìˆ˜ëŸ‰ ì…ë ¥ -->
                <label for="quantity">ìˆ˜ëŸ‰:</label>
                <input type="number" name="quantity" value="1" min="1" id="quantity" required />
        
                <!-- ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ë²„íŠ¼ -->
                <button type="submit" name="action" value="add_to_cart">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
        
                <!-- ë°”ë¡œ êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ -->
                <button type="submit" formaction="{% url 'shop:direct_purchase' product.id %}" class="btn btn-success">ë°”ë¡œ êµ¬ë§¤í•˜ê¸°</button>
            </form>
        </div>
        

        
        <script>
            var IMP = window.IMP; 
            IMP.init("imp71874747"); 
    
            function requestPay() {
              IMP.request_pay({
                pg: "html5_inicis",
                pay_method: "card",
                merchant_uid: "ORD20180131-0000011",   // ì£¼ë¬¸ë²ˆí˜¸
                name: "{{ product.name }}",
                amount: "{{ product.price }}",                         // ìˆ«ì íƒ€ì…
                buyer_email: "gildong@gmail.com",
                buyer_name: "{{ user.last_name }}",
                buyer_tel: "{{ user.tel}}",
                buyer_addr: "{{ user.address }}",
                buyer_postcode: "{{ user.postcode }}"
              }, function (rsp) { // callback
                //rsp.imp_uid ê°’ìœ¼ë¡œ ê²°ì œ ë‹¨ê±´ì¡°íšŒ APIë¥¼ í˜¸ì¶œí•˜ì—¬ ê²°ì œê²°ê³¼ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.
                if ( rsp.success ) {
                    jquery.ajax({
                        url:"/payments/complete/",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            imp_uid : rsp.imp_uid
                        }
                    }).done(function(data) {
                        //[2] ì„œë²„ì—ì„œ REST APIë¡œ ê²°ì œì •ë³´í™•ì¸ ë° ì„œë¹„ìŠ¤ë£¨í‹´ì´ ì •ìƒì ì¸ ê²½ìš°
                        alert("ajax done");               
                        console.log("ajax done");
                        if ( everythings_fine ) {
                         var msg = 'ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                         msg += '\nê³ ìœ ID : ' + rsp.imp_uid;
                         msg += '\nìƒì  ê±°ë˜ID : ' + rsp.merchant_uid;
                         msg += '\ê²°ì œ ê¸ˆì•¡ : ' + rsp.paid_amount;
                         msg += 'ì¹´ë“œ ìŠ¹ì¸ë²ˆí˜¸ : ' + rsp.apply_num;
    
                         alert(msg);
                         console.log(msg);
                        } else {
                         //[3] ì•„ì§ ì œëŒ€ë¡œ ê²°ì œê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                         //[4] ê²°ì œëœ ê¸ˆì•¡ì´ ìš”ì²­í•œ ê¸ˆì•¡ê³¼ ë‹¬ë¼ ê²°ì œë¥¼ ìë™ì·¨ì†Œì²˜ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.
                         var msg = 'ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.';
                         msg += 'ì—ëŸ¬ë‚´ìš© : ' + rsp.error_msg;
                 
                         alert(msg);
                         console.log(msg);
                        }
            }).fail(function () {
    
                alert("ajax fail");
    
                console.log("ajax fail");
    
            }).always(function () {
    
                alert("ajax always");
    
                console.log("ajax always");
              });
            } else {
    
                var msg = 'ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.';
    
                msg += 'ì—ëŸ¬ë‚´ìš© : ' + rsp.error_msg;
    
    
                alert(msg);
            }
        });
    }
    
          </script>
    

    </div>


    

</div> 



<script>
    function toggleLike(productId) {
        const likeButton = document.getElementById('like-btn');
        const likeCountSpan = document.getElementById('like-count');

        fetch(`/shop/product/${productId}/toggle_like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',  // CSRF í† í° ì„¤ì •
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            if (data.liked) {
                likeButton.innerHTML = 'â¤ï¸';
            } else {
                likeButton.innerHTML = 'ğŸ¤';
            }
            likeCountSpan.innerText = data.like_count;
        })
        .catch(error => console.error('Error:', error));
    }
</script>
    <!-- Q&A ì„¹ì…˜ -->
    <div class="product-qna">
        <input type="hidden" id="productId" value="{{ product.id }}">
        <h3>ìƒí’ˆ Q&A ({{ total_qna_count }})</h3>
        
        <!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ -->
        <div class="category-buttons">
            <a href="?category_id=" class="{% if not selected_category_id %}selected{% endif %}">ALL</a>
            {% for category in qna_categories %}
                <a href="?category_id={{ category.id }}" 
                   class="{% if category.id == selected_category_id %}selected{% endif %}">
                    {{ category.qna_name }} ({{ category.qna_count }})
                </a>
            {% endfor %}
        </div>

        <!-- New QnA ë§í¬ -->
        <div class="qna-actions">
            <a href="javascript:void(0);" onclick="toggleForm()" class="new-qna-btn">New QnA</a>
        </div>

        <!-- QnA ëª©ë¡ -->
        <div class="qna-list">
            {% for qna in qnas %}
                <div class="qna-item" id="qna-item-{{ qna.pk }}">
                    <div class="qna-header">
                        <a href="javascript:void(0);" onclick="toggleDetail({{ qna.pk }})" class="qna-title">
                            [{{ qna.category.qna_name }}] 
                            {% if qna.is_private %}ë¹„ë°€ê¸€ì…ë‹ˆë‹¤.{% else %}{{ qna.title }}{% endif %}
                        </a>
                        <div class="qna-meta">
                            <span class="qna-writer">{{ qna.writer.name }}</span>
                            <span class="qna-date">{{ qna.created_at|date:"Y-m-d H:i" }}</span>
                            <span class="qna-status {% if qna.reply %}answered{% else %}pending{% endif %}">
                                {% if qna.reply %}ë‹µë³€ì™„ë£Œ{% else %}ë‹µë³€ëŒ€ê¸°{% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <!-- ì§ˆë¬¸ ìƒì„¸ ë‚´ìš©ì´ í‘œì‹œë  div (ì´ˆê¸° ìƒíƒœëŠ” ìˆ¨ê¹€) -->
                    <div id="qna-detail-{{ qna.pk }}" class="qna-detail" style="display: none;"></div>
                </div>
            {% empty %}
                <div class="no-qna">í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endfor %}
        </div>
    </div>

    <script>
        function toggleForm() {
            const productId = document.getElementById("productId").value;
            if (!productId) {
                alert("product_idê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            // ìƒˆë¡œìš´ QnA ì‘ì„± í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `/qna/new/?product_id=${productId}`;
        }

        function toggleDetail(pk) {
            const detailDiv = document.getElementById(`qna-detail-${pk}`);
            
            // ìƒì„¸ë³´ê¸°ê°€ ì´ë¯¸ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ìŒ
            if (detailDiv.style.display === "block") {
                detailDiv.style.display = "none";
                detailDiv.innerHTML = ""; // ë‚´ìš©ì„ ë¹„ì›€
            } else {
                // Ajax ìš”ì²­ìœ¼ë¡œ qna_detail.html ê°€ì ¸ì˜¤ê¸°
                fetch(`/qna/${pk}/detail/`)
                    .then(response => response.text())
                    .then(html => {
                        detailDiv.innerHTML = html;
                        detailDiv.style.display = "block";
                    })
                    .catch(error => console.error("Error loading details:", error));
            }
        }
    </script>

    <!-- ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
    <div class="product-reviews">
        <h3>ë¦¬ë·°</h3>
        {% if reviews %}
            <ul class="review-list">
                {% for review in reviews %}
                    <li class="review-item">
                        <div class="review-header">
                            <span class="review-user">{{ review.user.username }}</span>
                            <span class="review-rating">{{ review.rating }}ì </span>
                            <span class="review-date">{{ review.created_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div class="review-content">{{ review.content }}</div>
                        {% if review.images.all %}
                            <div class="review-images">
                                {% for img in review.images.all %}
                                    <img src="{{ img.image.url }}" alt="ë¦¬ë·° ì´ë¯¸ì§€" style="max-width:100px; max-height:100px; margin:4px;">
                                {% endfor %}
                            </div>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="no-reviews">ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        {% endif %}
    </div>

    
    <script>
        // ë©”ì¸ ì´ë¯¸ì§€ Swiper ì´ˆê¸°í™” (í—¤ë“œ + ìƒì„¸ ì´ë¯¸ì§€)
        const productImageSwiper = new Swiper('.product-image-swiper', {
            loop: true,
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
            },
            navigation: {
                nextEl: '.product-image-swiper .swiper-button-next',
                prevEl: '.product-image-swiper .swiper-button-prev',
            },
            pagination: {
                el: '.product-image-swiper .swiper-pagination',
                clickable: true,
            },
            slidesPerView: 1,
            spaceBetween: 0,
        });
    </script>
    {% endblock content %}
