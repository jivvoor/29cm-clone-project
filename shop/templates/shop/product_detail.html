{% extends "shop/base.html" %}
{% load static %}
{% block page_title %}
    {{product.p_name}}
{% endblock page_title %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/product_detail.css' %}">
<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<h2>

    <a href="{% url 'users:user_profile' product.host.username %}">{{ product.host.username }}</a>
    {% if product.host.superhost %}
        (superhost)
    {% endif %}
</h2>
<div class="product-detail-container">
    <!-- 왼쪽: 메인 이미지 (Swiper로 변경) -->
    <div class="product-image">
        <div class="swiper product-image-swiper">
            <div class="swiper-wrapper">
                <div class="swiper-slide">
                    <img src="{{ product.head_image.url }}" alt="{{ product.name }}" class="product-head-image">
                </div>
                {% for detail_image in product.detail_images.all %}
                <div class="swiper-slide">
                    <img src="{{ detail_image.image.url }}" alt="{{ product.name }} - 상세 이미지 {{ forloop.counter }}" class="detail-image">
                </div>
                {% endfor %}
            </div>
            <!-- 네비게이션 화살표 -->
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
            <!-- 페이지네이션 -->
            <div class="swiper-pagination"></div>
        </div>
    </div>
    
    <!-- 오른쪽: 상품 정보 -->
    <div class="product-info">
        <h1>{{ product.name }}</h1>
        <p class="price">{{ product.price }}원</p>
        
        <!-- 좋아요 버튼과 수 표시 -->
        <div class="like-section">
            <button id="like-btn" onclick="toggleLike({{ product.id }})" class="like-button">
                {% if user_has_liked %}❤️{% else %}🤍{% endif %}
            </button>
            <span id="like-count">{{ like_count }}</span>명이 좋아합니다
        </div>
        
        <form method="post" action="{% url 'cart:add_cart' product.id %}">
                {% csrf_token %}
        
                <!-- 사이즈 선택 -->
                <label for="sizecategory">사이즈:</label>
                <select name="sizecategory" id="sizecategory" required>
                    {% for size in sizes %}
                        <option value="{{ size.id }}">{{ size.name }}</option>
                    {% endfor %}
                </select>
        
                <!-- 색상 선택 -->
                <label for="colorcategory">색상:</label>
                <select name="colorcategory" id="colorcategory" required>
                    {% for color in colors %}
                        <option value="{{ color.id }}">{{ color.name }}</option>
                    {% endfor %}
                </select>
        
                <!-- 수량 입력 -->
                <label for="quantity">수량:</label>
                <input type="number" name="quantity" value="1" min="1" id="quantity" required />
        
                <!-- 장바구니 담기 버튼 -->
                <button type="submit" name="action" value="add_to_cart">장바구니 담기</button>
        
                <!-- 바로 구매하기 버튼 -->
                <button type="submit" formaction="{% url 'shop:direct_purchase' product.id %}" class="btn btn-success">바로 구매하기</button>
            </form>
        </div>
        

        
        <script>
            var IMP = window.IMP; 
            IMP.init("imp71874747"); 
    
            function requestPay() {
              IMP.request_pay({
                pg: "html5_inicis",
                pay_method: "card",
                merchant_uid: "ORD20180131-0000011",   // 주문번호
                name: "{{ product.name }}",
                amount: "{{ product.price }}",                         // 숫자 타입
                buyer_email: "gildong@gmail.com",
                buyer_name: "{{ user.last_name }}",
                buyer_tel: "{{ user.tel}}",
                buyer_addr: "{{ user.address }}",
                buyer_postcode: "{{ user.postcode }}"
              }, function (rsp) { // callback
                //rsp.imp_uid 값으로 결제 단건조회 API를 호출하여 결제결과를 판단합니다.
                if ( rsp.success ) {
                    jquery.ajax({
                        url:"/payments/complete/",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            imp_uid : rsp.imp_uid
                        }
                    }).done(function(data) {
                        //[2] 서버에서 REST API로 결제정보확인 및 서비스루틴이 정상적인 경우
                        alert("ajax done");               
                        console.log("ajax done");
                        if ( everythings_fine ) {
                         var msg = '결제가 완료되었습니다.';
                         msg += '\n고유ID : ' + rsp.imp_uid;
                         msg += '\n상점 거래ID : ' + rsp.merchant_uid;
                         msg += '\결제 금액 : ' + rsp.paid_amount;
                         msg += '카드 승인번호 : ' + rsp.apply_num;
    
                         alert(msg);
                         console.log(msg);
                        } else {
                         //[3] 아직 제대로 결제가 되지 않았습니다.
                         //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
                         var msg = '결제에 실패하였습니다.';
                         msg += '에러내용 : ' + rsp.error_msg;
                 
                         alert(msg);
                         console.log(msg);
                        }
            }).fail(function () {
    
                alert("ajax fail");
    
                console.log("ajax fail");
    
            }).always(function () {
    
                alert("ajax always");
    
                console.log("ajax always");
              });
            } else {
    
                var msg = '결제에 실패하였습니다.';
    
                msg += '에러내용 : ' + rsp.error_msg;
    
    
                alert(msg);
            }
        });
    }
    
          </script>
    

    </div>


    

</div> 



<script>
    function toggleLike(productId) {
        const likeButton = document.getElementById('like-btn');
        const likeCountSpan = document.getElementById('like-count');

        fetch(`/shop/product/${productId}/toggle_like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',  // CSRF 토큰 설정
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            if (data.liked) {
                likeButton.innerHTML = '❤️';
            } else {
                likeButton.innerHTML = '🤍';
            }
            likeCountSpan.innerText = data.like_count;
        })
        .catch(error => console.error('Error:', error));
    }
</script>
    <!-- Q&A 섹션 -->
    <div class="product-qna">
        <input type="hidden" id="productId" value="{{ product.id }}">
        <h3>상품 Q&A ({{ total_qna_count }})</h3>
        
        <!-- 카테고리 버튼 -->
        <div class="category-buttons">
            <a href="?category_id=" class="{% if not selected_category_id %}selected{% endif %}">ALL</a>
            {% for category in qna_categories %}
                <a href="?category_id={{ category.id }}" 
                   class="{% if category.id == selected_category_id %}selected{% endif %}">
                    {{ category.qna_name }} ({{ category.qna_count }})
                </a>
            {% endfor %}
        </div>

        <!-- New QnA 링크 -->
        <div class="qna-actions">
            <a href="javascript:void(0);" onclick="toggleForm()" class="new-qna-btn">New QnA</a>
        </div>

        <!-- QnA 목록 -->
        <div class="qna-list">
            {% for qna in qnas %}
                <div class="qna-item" id="qna-item-{{ qna.pk }}">
                    <div class="qna-header">
                        <a href="javascript:void(0);" onclick="toggleDetail({{ qna.pk }})" class="qna-title">
                            [{{ qna.category.qna_name }}] 
                            {% if qna.is_private %}비밀글입니다.{% else %}{{ qna.title }}{% endif %}
                        </a>
                        <div class="qna-meta">
                            <span class="qna-writer">{{ qna.writer.name }}</span>
                            <span class="qna-date">{{ qna.created_at|date:"Y-m-d H:i" }}</span>
                            <span class="qna-status {% if qna.reply %}answered{% else %}pending{% endif %}">
                                {% if qna.reply %}답변완료{% else %}답변대기{% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <!-- 질문 상세 내용이 표시될 div (초기 상태는 숨김) -->
                    <div id="qna-detail-{{ qna.pk }}" class="qna-detail" style="display: none;"></div>
                </div>
            {% empty %}
                <div class="no-qna">해당 카테고리에 게시물이 없습니다.</div>
            {% endfor %}
        </div>
    </div>

    <script>
        function toggleForm() {
            const productId = document.getElementById("productId").value;
            if (!productId) {
                alert("product_id가 없습니다.");
                return;
            }
            // 새로운 QnA 작성 페이지로 이동
            window.location.href = `/qna/new/?product_id=${productId}`;
        }

        function toggleDetail(pk) {
            const detailDiv = document.getElementById(`qna-detail-${pk}`);
            
            // 상세보기가 이미 열려있다면 닫음
            if (detailDiv.style.display === "block") {
                detailDiv.style.display = "none";
                detailDiv.innerHTML = ""; // 내용을 비움
            } else {
                // Ajax 요청으로 qna_detail.html 가져오기
                fetch(`/qna/${pk}/detail/`)
                    .then(response => response.text())
                    .then(html => {
                        detailDiv.innerHTML = html;
                        detailDiv.style.display = "block";
                    })
                    .catch(error => console.error("Error loading details:", error));
            }
        }
    </script>

    <!-- 리뷰 리스트 출력 -->
    <div class="product-reviews">
        <h3>리뷰</h3>
        {% if reviews %}
            <ul class="review-list">
                {% for review in reviews %}
                    <li class="review-item">
                        <div class="review-header">
                            <span class="review-user">{{ review.user.username }}</span>
                            <span class="review-rating">{{ review.rating }}점</span>
                            <span class="review-date">{{ review.created_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div class="review-content">{{ review.content }}</div>
                        {% if review.images.all %}
                            <div class="review-images">
                                {% for img in review.images.all %}
                                    <img src="{{ img.image.url }}" alt="리뷰 이미지" style="max-width:100px; max-height:100px; margin:4px;">
                                {% endfor %}
                            </div>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="no-reviews">아직 작성된 리뷰가 없습니다.</div>
        {% endif %}
    </div>

    
    <script>
        // 메인 이미지 Swiper 초기화 (헤드 + 상세 이미지)
        const productImageSwiper = new Swiper('.product-image-swiper', {
            loop: true,
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
            },
            navigation: {
                nextEl: '.product-image-swiper .swiper-button-next',
                prevEl: '.product-image-swiper .swiper-button-prev',
            },
            pagination: {
                el: '.product-image-swiper .swiper-pagination',
                clickable: true,
            },
            slidesPerView: 1,
            spaceBetween: 0,
        });
    </script>
    {% endblock content %}
