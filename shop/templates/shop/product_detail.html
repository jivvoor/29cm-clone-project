{% extends "shop/base.html" %}
{% block page_title %}
    {{product.p_name}}
{% endblock page_title %}
{% block content %}
<h2>
    By :
    <a href="{% url 'users:user_profile' product.host.username %}">{{ product.host.username }}</a>
    {% if product.host.superhost %}
        (superhost)
    {% endif %}
</h2>
<div class="product-detail-container">
    <!-- ì™¼ìª½: ì´ë¯¸ì§€ -->
    <div class="product-image">
        <img src="{{ product.head_image.url }}" alt="{{ product.name }}" class="product-head-image">
    </div>
    
    <!-- ì˜¤ë¥¸ìª½: ìƒí’ˆ ì •ë³´ -->
    <div class="product-info">
        <h1>{{ product.name }}</h1>
        <p class="price">{{ product.price }}ì›</p>
        <p class="description">{{ product.description }}</p>
        
        <!-- ì¢‹ì•„ìš” ë²„íŠ¼ê³¼ ìˆ˜ í‘œì‹œ -->
        <div class="like-section">
            <button id="like-btn" onclick="toggleLike({{ product.id }})" class="like-button">
                {% if user_has_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}
            </button>
            <span id="like-count">{{ like_count }}</span>ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤
        </div>
        
        <form method="post" action="{% url 'shop:add_to_cart' product.id %}">
                {% csrf_token %}
        
                <!-- ì‚¬ì´ì¦ˆ ì„ íƒ -->
                <label for="sizecategory">ì‚¬ì´ì¦ˆ:</label>
                <select name="sizecategory" id="sizecategory" required>
                    {% for size in sizes %}
                        <option value="{{ size.id }}">{{ size.name }}</option>
                    {% endfor %}
                </select>
        
                <!-- ìƒ‰ìƒ ì„ íƒ -->
                <label for="colorcategory">ìƒ‰ìƒ:</label>
                <select name="colorcategory" id="colorcategory" required>
                    {% for color in colors %}
                        <option value="{{ color.id }}">{{ color.name }}</option>
                    {% endfor %}
                </select>
        
                <!-- ìˆ˜ëŸ‰ ì…ë ¥ -->
                <label for="quantity">ìˆ˜ëŸ‰:</label>
                <input type="number" name="quantity" value="1" min="1" id="quantity" required />
        
                <!-- ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ë²„íŠ¼ -->
                <button type="submit" name="action" value="add_to_cart">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
        
                <!-- ë°”ë¡œ êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ -->
                <button type="submit" formaction="{% url 'shop:direct_purchase' product.id %}" class="btn btn-success">ë°”ë¡œ êµ¬ë§¤í•˜ê¸°</button>
            </form>
        </div>
        
        <script>
            var IMP = window.IMP; 
            IMP.init("imp71874747"); 
    
            function requestPay() {
              IMP.request_pay({
                pg: "html5_inicis",
                pay_method: "card",
                merchant_uid: "ORD20180131-0000011",   // ì£¼ë¬¸ë²ˆí˜¸
                name: "{{ product.name }}",
                amount: "{{ product.price }}",                         // ìˆ«ì íƒ€ì…
                buyer_email: "gildong@gmail.com",
                buyer_name: "{{ user.last_name }}",
                buyer_tel: "{{ user.tel}}",
                buyer_addr: "{{ user.address }}",
                buyer_postcode: "{{ user.postcode }}"
              }, function (rsp) { // callback
                //rsp.imp_uid ê°’ìœ¼ë¡œ ê²°ì œ ë‹¨ê±´ì¡°íšŒ APIë¥¼ í˜¸ì¶œí•˜ì—¬ ê²°ì œê²°ê³¼ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.
                if ( rsp.success ) {
                    jquery.ajax({
                        url:"/payments/complete/",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            imp_uid : rsp.imp_uid
                        }
                    }).done(function(data) {
                        //[2] ì„œë²„ì—ì„œ REST APIë¡œ ê²°ì œì •ë³´í™•ì¸ ë° ì„œë¹„ìŠ¤ë£¨í‹´ì´ ì •ìƒì ì¸ ê²½ìš°
                        alert("ajax done");               
                        console.log("ajax done");
                        if ( everythings_fine ) {
                         var msg = 'ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                         msg += '\nê³ ìœ ID : ' + rsp.imp_uid;
                         msg += '\nìƒì  ê±°ë˜ID : ' + rsp.merchant_uid;
                         msg += '\ê²°ì œ ê¸ˆì•¡ : ' + rsp.paid_amount;
                         msg += 'ì¹´ë“œ ìŠ¹ì¸ë²ˆí˜¸ : ' + rsp.apply_num;
    
                         alert(msg);
                         console.log(msg);
                        } else {
                         //[3] ì•„ì§ ì œëŒ€ë¡œ ê²°ì œê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                         //[4] ê²°ì œëœ ê¸ˆì•¡ì´ ìš”ì²­í•œ ê¸ˆì•¡ê³¼ ë‹¬ë¼ ê²°ì œë¥¼ ìë™ì·¨ì†Œì²˜ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.
                         var msg = 'ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.';
                         msg += 'ì—ëŸ¬ë‚´ìš© : ' + rsp.error_msg;
                 
                         alert(msg);
                         console.log(msg);
                        }
            }).fail(function () {
    
                alert("ajax fail");
    
                console.log("ajax fail");
    
            }).always(function () {
    
                alert("ajax always");
    
                console.log("ajax always");
              });
            } else {
    
                var msg = 'ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.';
    
                msg += 'ì—ëŸ¬ë‚´ìš© : ' + rsp.error_msg;
    
    
                alert(msg);
            }
        });
    }
    
          </script>
    

    </div>
</div>

<script>
    function toggleLike(productId) {
        const likeButton = document.getElementById('like-btn');
        const likeCountSpan = document.getElementById('like-count');

        fetch(`/shop/product/${productId}/toggle_like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',  // CSRF í† í° ì„¤ì •
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            if (data.liked) {
                likeButton.innerHTML = 'â¤ï¸';
            } else {
                likeButton.innerHTML = 'ğŸ¤';
            }
            likeCountSpan.innerText = data.like_count;
        })
        .catch(error => console.error('Error:', error));
    }
</script>
    <div class="product-qna">
        <input type="hidden" id="productId" value="{{ product.id }}">
        {% include 'qna_index.html' with qnas=qnas qna_categories=qna_categories %}  <!-- qna_categories ì „ë‹¬ -->
    </div>

    <!-- ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
    <div class="product-reviews">
        <h3>ë¦¬ë·°</h3>
        {% if reviews %}
            <ul class="review-list">
                {% for review in reviews %}
                    <li class="review-item">
                        <div class="review-header">
                            <span class="review-user">{{ review.user.username }}</span>
                            <span class="review-rating">{{ review.rating }}ì </span>
                            <span class="review-date">{{ review.created_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div class="review-content">{{ review.content }}</div>
                        {% if review.images.all %}
                            <div class="review-images">
                                {% for img in review.images.all %}
                                    <img src="{{ img.image.url }}" alt="ë¦¬ë·° ì´ë¯¸ì§€" style="max-width:100px; max-height:100px; margin:4px;">
                                {% endfor %}
                            </div>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="no-reviews">ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        {% endif %}
    </div>

<style>
    .product-detail-container {
        display: flex;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        gap: 40px;
    }

    .product-image {
        flex: 1;
        max-width: 500px;
    }

    .product-image img {
        width: 100%;
        height: auto;
        border-radius: 8px;
    }

    .product-info {
        flex: 1;
        padding: 20px;
    }

    .product-info h1 {
        margin-bottom: 15px;
        color: #333;
    }

    .price {
        font-size: 24px;
        font-weight: bold;
        color: #e74c3c;
        margin-bottom: 15px;
    }

    .description {
        color: #666;
        line-height: 1.6;
        margin-bottom: 20px;
    }

    .like-section {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding: 10px 0;
    }

    .like-button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: transform 0.2s;
    }

    .like-button:hover {
        transform: scale(1.1);
    }

    #like-count {
        font-weight: bold;
        color: #e74c3c;
    }

    .product-reviews {
        margin-top: 40px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .product-reviews h3 {
        margin-bottom: 20px;
        color: #333;
    }

    .review-list {
        list-style: none;
        padding: 0;
    }

    .review-item {
        background: white;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 14px;
        color: #666;
    }

    .review-user {
        font-weight: bold;
        color: #333;
    }

    .review-rating {
        color: #ff6b35;
        font-weight: bold;
    }

    .review-content {
        line-height: 1.6;
        margin-bottom: 10px;
    }

    .review-images {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .no-reviews {
        text-align: center;
        color: #666;
        padding: 20px;
    }
</style>    
    {% endblock content %}
